<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë–¡ì¹˜ê¸°-í† ë¼</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
        }
        #timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-color: red;
            transition: none;
        }
        #game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 50px;
        }
        #output {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .game-button {
            width: 60px;
            height: 60px;
            font-size: 24px;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            
            transform: scale(1.2);
            margin: 5px; /* ë²„íŠ¼ ê°„ ì—¬ë°± ì¶”ê°€ */
        }


        .button-1 {
            background-image: url('1ë²ˆ.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
        }

        .button-2 {
            background-image: url('2ë²ˆ.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
        }

        .button-3 {
            background-image: url('3ë²ˆ.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
        }

        .button-0 {

            background-image: url('0ë²ˆ.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
            position: relative;
            left: -15px;
            outline: none; /* í¬ì»¤ìŠ¤ ì‹œ ì™¸ê³½ì„  ì œê±° */
            box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
        }

        .pattern {
            position: relative;
            display: inline-block;
            width: 26px; /* ê¸°ì¡´ 24px â†’ 26px (ì¢Œìš° ê°„ê²© ì¦ê°€) */
            text-align: center;
            margin-right: 4px; /* ìˆ«ì ì‚¬ì´ ê°„ê²© ì¦ê°€ */
            margin-bottom: 12px; /* ê¸°ì¡´ë³´ë‹¤ ì•½ê°„ë§Œ ì•„ë˜ìª½ ê°„ê²© ì¦ê°€ */
            font-size: 0;
        }

        .pattern::after {
            content: "";
            position: absolute;
            bottom: 0px; /* ìˆ«ì ìë¦¬ì— ë°°ì¹˜ */
            left: 50%;
            transform: translateX(-50%);
            width: 34px;  /* ì‘ì€ ì› í¬ê¸° */
            height: 34px;
            border-radius: 50%; /* ì›í˜• */
        }

        /* ìˆ«ìë³„ ì› ìƒ‰ìƒ ì§€ì • */
        .pattern[data-value="1"]::after {
            background-color: #0047AB; /* íŒŒë€ìƒ‰ */
        }
        .pattern[data-value="2"]::after {
            background-color: yellowgreen; /* ë…¹ìƒ‰ */
        }
        .pattern[data-value="3"]::after {
            background-color: #FF69B4; /* í•‘í¬ìƒ‰ */
        }
        .pattern[data-value="0"]::after {
            background-color: teal; /* ì²­ë¡ìƒ‰ */
        }

        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ì— ì¶”ê°€ */
        .correct::after {
            filter: brightness(200%);
            opacity: 0.6;
            border: 2px solid #00aa00; /* ì§„í•œ ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬ */
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8); /* ë°ì€ ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬ ê°•ì¡° íš¨ê³¼ */
        }



.game-button {
    width: 60px;
    height: 60px;
    font-size: 24px;
    padding: 10px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    
    transform: scale(1.2);
}

        .correct {
            color: lightgray;
        }
        #button-container {
            position: fixed;
            bottom: 70px; /*ì „ì²´ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •*/
            left: 50%;
            transform: translateX(-50%);
        }
        #start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 0px;
        }
#play-count {
    margin-bottom: 0px; /* ê¸°ë³¸ ê°’ë³´ë‹¤ ì¤„ì—¬ì„œ ê°„ê²© ì¡°ì • */
}

#output {
    margin-top: 0px; /* ê¸°ë³¸ ê°’ë³´ë‹¤ ì¤„ì—¬ì„œ ê°„ê²© ì¡°ì • */
}
    </style>
</head>
<body>
    <div id="timer-bar"></div>
    <h1>ë–¡ì¹˜ê¸°-í† ë¼</h1>

    <div id="start-buttons">
        <p id="user-info">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        
        <!-- ë²„íŠ¼ ë˜í¼ (ê²Œì„ ì‹œì‘ + ë¼ì§€ ë²„íŠ¼) -->
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="start-button">ê²Œì„ ì‹œì‘</button>
            <button id="nickname-button">ë‹‰ë„¤ì„ ë³€ê²½</button>
            <button id="pig-button">ë¼ì§€</button>
        </div>

        <p id="play-count">í”Œë ˆì´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p> <!-- ì¶”ê°€ëœ ë¬¸êµ¬ -->
    </div>
    
    <div id="game-container">
        <p id="output">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <div id="button-container" class="game-buttons"></div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, setDoc, getDoc, doc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCqEtavkrRLd8zSLSTRNKB4aSDpo_dRXFw",
          authDomain: "rabbit-fe7c9.firebaseapp.com",
          projectId: "rabbit-fe7c9",
          storageBucket: "rabbit-fe7c9.firebasestorage.app",
          messagingSenderId: "8805323656",
          appId: "1:8805323656:web:19bfc7adab21c09fe2a03d"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let rowNumbers = document.createElement("div");
rowNumbers.style.display = "flex";
rowNumbers.style.justifyContent = "space-between";
rowNumbers.style.gap = "400px";  // ë²„íŠ¼ ì‚¬ì´ì— 20px ê°„ê²© ì¶”ê°€
rowNumbers.style.position = "relative";
rowNumbers.style.top = "100px"; // ì›í•˜ëŠ” ë§Œí¼ ì˜¬ë¦¬ê¸°

// rowNumbers.style.width = "180px"; // ê³ ì • í­ ì œê±° ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬



        let gameActive = false;
        let round = 0;
        let currentAnswer = "";
        let inputSequence = "";
        let colorsPig = ["1", "2", "3"];
        let timer;
        let nickname = localStorage.getItem("nickname");

        function promptNickname() {
            if (!nickname) {
                nickname = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
                if (!nickname) {
                    alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return false;
                }
                localStorage.setItem("nickname", nickname);
            }
            return true;
        }

        document.getElementById("nickname-button").addEventListener("click", function () {
        let nickname = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
        if (nickname) {
            localStorage.setItem("nickname", nickname);
            alert(`ë‹‰ë„¤ì„ì´ "${nickname}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }
    });

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("start-button").addEventListener("click", startGame);
             // ë¼ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ URL ì´ë™
             document.getElementById("pig-button").addEventListener("click", function () {
                window.location.href = "https://hanaida.github.io/mafia42/";
            });
        });

        async function loadPlayCount() {
    const resultsRef = collection(db, "game_results");
    const resultsSnapshot = await getDocs(resultsRef);

    let totalCount = 0;

    resultsSnapshot.forEach((doc) => {
        totalCount += doc.data().play_count || 0;
    });

    document.getElementById("play-count").innerHTML = 
    `ì§€ê¸ˆê¹Œì§€ <span style="color: red;">ì´ ${totalCount}íšŒ</span> í”Œë ˆì´ë˜ì—ˆìŠµë‹ˆë‹¤.`;
}

        let rankingCache = "ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."; // ë­í‚¹ì„ ì„ì‹œë¡œ ì €ì¥í•˜ëŠ” ë³€ìˆ˜

        async function loadRanking() {
    const rankingRef = collection(db, "game_results");

    // ë¼ìš´ë“œ ê¸°ì¤€ ë­í‚¹ (ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬)
    const roundQuery = query(rankingRef, orderBy("round", "desc"), limit(5));
    const roundSnapshot = await getDocs(roundQuery);

    const roundRanking = roundSnapshot.empty 
        ? "ì•„ì§ ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
        : `<span style="color: red; font-weight: bold; font-size: 35px;">í† ë¼ì˜ ì „ë‹¹</span><br><br>
           <span style="font-size: 20px; font-weight: bold;">ğŸ° ë¼ìš´ë“œ ë¶€ë¬¸</span><br><span style="color: black; font-size: 12px;">ë­í‚¹ ë³´ìƒ(ì¼ìš”ì¼ ì§€ê¸‰) - 1ìœ„ : ê¹œì£¼ 2-3ìœ„ : ê¹œì—½ 4-5ìœ„ : ì£¼ì—½</span><br><br>` + 
          Array.from(roundSnapshot.docs, (doc, index) => 
              `${index + 1}ìœ„: ${doc.data().nickname} - ${doc.data().round} round`
          ).join("<br>");

    // íŒìˆ˜ ê¸°ì¤€ ë­í‚¹ (ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬)
    const playCountQuery = query(rankingRef, orderBy("play_count", "desc"), limit(5));
    const playCountSnapshot = await getDocs(playCountQuery);

    const playCountRanking = playCountSnapshot.empty
        ? ""
        : `<br><br><span style="font-size: 20px; font-weight: bold;">ğŸ® íŒìˆ˜ ë¶€ë¬¸</span><br><span style="color: black; font-size: 12px;">ë­í‚¹ ë³´ìƒ(ì¼ìš”ì¼ ì§€ê¸‰) - 1ìœ„ : ê¹œì—½ 2-3ìœ„ : ì£¼ì—½ 4-5ìœ„ : ê³ ì¼</span><br><br>` + 
          Array.from(playCountSnapshot.docs, (doc, index) => 
              `${index + 1}ìœ„: ${doc.data().nickname} - ${doc.data().play_count}íŒ`
          ).join("<br>");

    // ìµœì¢… ì¶œë ¥í•  ë­í‚¹
    rankingCache = roundRanking + playCountRanking + '<br><br><br><br>';

    if (!gameActive) {
        document.getElementById("output").innerHTML = rankingCache;
    }
}




// íš¨ê³¼ìŒ íŒŒì¼ ê²½ë¡œ ì„¤ì •
const soundEffects = {
    "1": new Audio("sound4.mp3"),
    "2": new Audio("sound5.mp3"),
    "3": new Audio("sound6.mp3"),
    "0": new Audio("sound0.mp3")
};



// ëª¨ë“  ì˜¤ë””ì˜¤ íŒŒì¼ì´ ë¡œë“œë˜ë„ë¡ ì„¤ì •
Object.values(soundEffects).forEach(audio => {
    audio.load(); // ì˜¤ë””ì˜¤ ë¯¸ë¦¬ ë¡œë“œ
});

        
// íš¨ê³¼ìŒ ì¤‘ì²© ì¬ìƒì„ ìœ„í•´ ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
// íš¨ê³¼ìŒì„ ë¹ ë¥´ê²Œ ì¬ìƒí•˜ê¸° ìœ„í•œ í•¨ìˆ˜
function playSound(soundKey) {
    if (soundEffects[soundKey]) {
        let soundClone = soundEffects[soundKey].cloneNode(); // ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        soundClone.play().catch(error => console.log("ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", error));
    }
}

// ë²„íŠ¼ì— ì¦‰ì‹œ ì…ë ¥ ë° íš¨ê³¼ìŒ ì¬ìƒ ì´ë²¤íŠ¸ ì¶”ê°€



async function loadUserInfo() {
    if (!nickname) {
        document.getElementById("user-info").innerText = "ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.";
        return;
    }

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);
    
    let userRound = 0;
    let totalPlayers = 0;
    let userRank = "ë°ì´í„° ì—†ìŒ";

    // ìœ ì € ìµœê³  ë¼ìš´ë“œ ê°€ì ¸ì˜¤ê¸°
    if (userSnap.exists()) {
        userRound = userSnap.data().round;
    }

    // ì „ì²´ ìœ ì € ë­í‚¹ ê°€ì ¸ì˜¤ê¸°
    const rankingRef = collection(db, "game_results");
    const rankingQuery = query(rankingRef, orderBy("round", "desc"));
    const rankingSnapshot = await getDocs(rankingQuery);

    totalPlayers = rankingSnapshot.size;

    let rank = 1;
    for (const doc of rankingSnapshot.docs) {
        if (doc.id === nickname) {
            userRank = rank;
            break;
        }
        rank++;
    }

    document.getElementById("user-info").innerHTML = `
        <strong>ë‹‰ë„¤ì„:</strong> ${nickname} <br>
        <strong>ìµœê³  ë¼ìš´ë“œ:</strong> ${userRound} <br>
        <strong>ë­í‚¹:</strong> ì „ì²´ ${totalPlayers}ëª… ì¤‘ <span style="color: blue;">${userRank}ë“±</span>
    `;
}





async function loadUserRecord() {
    if (!nickname) return; // ë‹‰ë„¤ì„ì´ ì—†ìœ¼ë©´ ì‹¤í–‰ ì•ˆ í•¨

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
        const userData = userSnap.data();
        document.getElementById("user-info").innerHTML = 
            `ë‹‰ë„¤ì„: <b>${nickname}</b><br>ìµœê³  ë¼ìš´ë“œ: <b>${userData.round}</b>`;
    } else {
        document.getElementById("user-info").innerHTML = 
            `ë‹‰ë„¤ì„: <b>${nickname}</b><br>ìµœê³  ë¼ìš´ë“œ: <b>ê¸°ë¡ ì—†ìŒ</b>`;
    }
}




        
        
        let backgroundMusic = new Audio("game-music.mp3"); // ì˜¤ë””ì˜¤ íŒŒì¼ ë¡œë“œ
backgroundMusic.loop = true; // ë°˜ë³µ ì¬ìƒ ì„¤ì •

function startGame() {
    if (!promptNickname()) return;
    if (gameActive) {
        alert("ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
        return;
    }

    gameActive = true;
    round = 0;
    inputSequence = "";
    document.getElementById("start-buttons").style.display = "none";
    generateQuestion();

    // ê²Œì„ì´ ì‹œì‘ë  ë•Œ ìŒì•… ì¬ìƒ
    backgroundMusic.play().catch(error => {
        console.log("ìë™ ì¬ìƒì´ ì°¨ë‹¨ë¨. ìœ ì € ì…ë ¥ í›„ ì¬ìƒ í•„ìš”", error);
    });
    
}


        function getPatternLength() {
            return 6 + Math.floor(round / 5) * 2;
        }

        function formatPattern(pattern) {
    return pattern
        .split('')
        .map((num) => `<span class="pattern" data-value="${num}">${num}</span>`)
        .reduce((acc, curr, index) => acc + curr + ((index + 1) % 6 === 0 ? "<br>" : " "), "");
}

        let reactionTimes = [];
let firstReactionTimes = [];
let roundStartTime;
let lastInputTime;

/**
 * ë°˜ì‘ì†ë„ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œìš´ ë¼ìš´ë“œë¥¼ ì‹œì‘í•  ë•Œ ì‹œê°„ì„ ì €ì¥
 */


 function generateQuestion() {
    clearTimeout(timer);
    resetTimerBar();
    
    roundStartTime = Date.now(); // ë¼ìš´ë“œ ì‹œì‘ ì‹œê°„ ì €ì¥
    lastInputTime = null; // ë§ˆì§€ë§‰ ì…ë ¥ ì‹œê°„ ì´ˆê¸°í™”
    
    let length = getPatternLength();
    let pattern = [];
    let remainingLength = length;
    
    // ì²« ë²ˆì§¸ ìˆ«ìëŠ” 0ì´ ì•„ë‹ ìˆ˜ë„ ìˆë„ë¡ ë³€ê²½
    if (remainingLength > 0) {
        let firstNum;
        do {
            firstNum = colorsPig[Math.floor(Math.random() * colorsPig.length)];
        } while (firstNum === "0");
        pattern.push(firstNum);
        remainingLength -= 1;
    }
    
    while (remainingLength > 0) {
        if (remainingLength > 2 && Math.random() < 0.4) { // 0ì´ ì¶œí˜„í•˜ëŠ” ë¹ˆë„ë¥¼ ì•½ê°„ ë‚®ì¶¤
            let maxZeroGroupSize = Math.min(8, Math.floor(remainingLength / 2) * 2); // ìµœëŒ€ 8ê°œì˜ 0ë§Œ í—ˆìš©
            let zeroGroupSize = Math.min((Math.floor(Math.random() * (maxZeroGroupSize / 2)) + 1) * 2, remainingLength - 2); // ì§ìˆ˜ ê°œìˆ˜ì˜ 0
            if (zeroGroupSize > 0) {
                pattern.push(...Array(zeroGroupSize).fill("0"));
                remainingLength -= zeroGroupSize;
            }
        }
        
        if (remainingLength > 0) {
            let randomNum;
            let attempts = 0;
            do {
                randomNum = colorsPig[Math.floor(Math.random() * colorsPig.length)];
                attempts++;
            } while (
                (pattern.length >= 2 && pattern[pattern.length - 1] === "1" && pattern[pattern.length - 2] === "2" && randomNum === "3") ||
                (pattern.length >= 2 && pattern[pattern.length - 1] === randomNum && pattern[pattern.length - 2] === randomNum)
            );
            
            pattern.push(randomNum);
            remainingLength -= 1;
        }
    }
    
    // 0ì˜ ê°œìˆ˜ê°€ í™€ìˆ˜ë©´ ë§ˆì§€ë§‰ 0 ì œê±°
    let zeroCount = pattern.filter(num => num === "0").length;
    if (zeroCount % 2 !== 0) {
        let lastZeroIndex = pattern.lastIndexOf("0");
        if (lastZeroIndex !== -1) {
            pattern.splice(lastZeroIndex, 1);
            remainingLength += 1;
        }
    }
    
    // ë°°ì—´ì˜ í¬ê¸°ë¥¼ ì •í™•íˆ lengthë¡œ ë§ì¶¤
    while (pattern.length < length) {
        let randomNum;
        do {
            randomNum = colorsPig[Math.floor(Math.random() * colorsPig.length)];
        } while (
            (pattern.length >= 2 && pattern[pattern.length - 1] === "1" && pattern[pattern.length - 2] === "2" && randomNum === "3") ||
            (pattern.length >= 2 && pattern[pattern.length - 1] === randomNum && pattern[pattern.length - 2] === randomNum)
        );
        pattern.push(randomNum);
    }
    while (pattern.length > length) {
        pattern.pop();
    }
    
    currentAnswer = pattern.join("");
    
    document.getElementById("output").innerHTML = formatPattern(currentAnswer);
    inputSequence = "";
    renderButtons();
    startTimer();
}









function addImmediateInputEvent(button, value) {
    button.onmousedown = () => {
        handleInput(value);
        playSound(value); // ë²„íŠ¼ í´ë¦­ ì‹œ íš¨ê³¼ìŒ ì¦‰ì‹œ ì¬ìƒ
    };
    button.ontouchstart = (e) => {
        e.preventDefault(); // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        handleInput(value);
        playSound(value);
    };
}


function renderButtons() {
    let container = document.getElementById("button-container");
    container.innerHTML = "";

    // 3 ë²„íŠ¼ ë˜í¼
    let btnGroup = document.createElement("div");
    btnGroup.style.display = "flex";
    btnGroup.style.flexDirection = "column";
    btnGroup.style.alignItems = "center";

    let btn3Wrapper = document.createElement("div");
    btn3Wrapper.style.width = "72px"; 
    btn3Wrapper.style.height = "72px";
    btn3Wrapper.style.display = "flex";
    btn3Wrapper.style.justifyContent = "center";
    btn3Wrapper.style.alignItems = "center";
    btn3Wrapper.style.position = "relative";
    btn3Wrapper.style.top = "72px"; // 3ë²ˆ ë²„íŠ¼ì„ 72px ì•„ë˜ë¡œ ì´ë™

    let btn3 = document.createElement("button");
    btn3.innerText = "3";
    btn3.classList.add("game-button", "button-3");
    addImmediateInputEvent(btn3, "3");
    btn3Wrapper.appendChild(btn3);
    btnGroup.appendChild(btn3Wrapper);

    // 1, 2ë²ˆ ë²„íŠ¼ ë˜í¼ (ì¢Œìš° ë°˜ì „: 2ê°€ ì™¼ìª½, 1ì´ ì˜¤ë¥¸ìª½)
    let rowNumbers = document.createElement("div");
    rowNumbers.style.display = "flex";
    rowNumbers.style.gap = "20px"; // ë²„íŠ¼ ì‚¬ì´ ê°„ê²© ìœ ì§€

    let btn1Wrapper = document.createElement("div");
    btn1Wrapper.style.width = "72px";
    btn1Wrapper.style.height = "72px";
    btn1Wrapper.style.display = "flex";
    btn1Wrapper.style.justifyContent = "center";
    btn1Wrapper.style.alignItems = "center";
    btn1Wrapper.style.position = "relative";
    btn1Wrapper.style.top = "-72px"; // 1ë²ˆ ë²„íŠ¼ì„ 72px ìœ„ë¡œ ì´ë™

    let btn1 = document.createElement("button");
    btn1.innerText = "1";
    btn1.classList.add("game-button", "button-1");
    addImmediateInputEvent(btn1, "1");
    btn1Wrapper.appendChild(btn1);

    let btn2Wrapper = document.createElement("div");
    btn2Wrapper.style.width = "72px";
    btn2Wrapper.style.height = "72px";
    btn2Wrapper.style.display = "flex";
    btn2Wrapper.style.justifyContent = "center";
    btn2Wrapper.style.alignItems = "center";
    btn2Wrapper.style.position = "relative";
    btn2Wrapper.style.top = "-72px"; // 2ë²ˆ ë²„íŠ¼ì„ 72px ìœ„ë¡œ ì´ë™

    let btn2 = document.createElement("button");
    btn2.innerText = "2";
    btn2.classList.add("game-button", "button-2");
    addImmediateInputEvent(btn2, "2");
    btn2Wrapper.appendChild(btn2);

    // ìˆœì„œë¥¼ ë°”ê¿” ì¶”ê°€ (ì›ë˜ 1 -> 2ì˜€ëŠ”ë° 2 -> 1ë¡œ ë³€ê²½)
    rowNumbers.appendChild(btn2Wrapper);
    rowNumbers.appendChild(btn1Wrapper);
    btnGroup.appendChild(rowNumbers);

    // í•˜ë‹¨ 0ë²ˆ ë²„íŠ¼ ë˜í¼ (ë°°ì¹˜ ë³€ê²½)
    let rowBottom = document.createElement("div");
    rowBottom.style.display = "flex";
    rowBottom.style.alignItems = "center";
    rowBottom.style.justifyContent = "space-between";
    rowBottom.style.width = "300px";

    let btn0Wrapper = document.createElement("div");
    btn0Wrapper.style.width = "72px";
    btn0Wrapper.style.height = "72px";
    btn0Wrapper.style.display = "flex";
    btn0Wrapper.style.justifyContent = "center";
    btn0Wrapper.style.alignItems = "center";
    btn0Wrapper.style.marginBottom = "-75px"; 
    btn0Wrapper.style.marginLeft = "36px"; // 0ë²ˆ ë²„íŠ¼ì„ 36px ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™

    let btn0 = document.createElement("button");
    btn0.innerText = "0";
    btn0.classList.add("game-button", "button-0");
    addImmediateInputEvent(btn0, "0");
    btn0Wrapper.appendChild(btn0);

    // ì¢Œìš° ë°˜ì „ëœ ìˆœì„œë¡œ ì¶”ê°€
    rowBottom.appendChild(btn0Wrapper); // ì™¼ìª½ì— 0ë²ˆ ë²„íŠ¼
    let spacer = document.createElement("div");
    spacer.style.width = "300px"; 
    rowBottom.appendChild(spacer);
    rowBottom.appendChild(btnGroup); // ì˜¤ë¥¸ìª½ì— ìˆ«ì ê·¸ë£¹

    container.appendChild(rowBottom);
}








        /**
 * ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ ë°˜ì‘ì†ë„ ì¸¡ì •
 */
let nextRoundPending = false; // ìƒˆë¡œìš´ ë³€ìˆ˜ ì¶”ê°€

function handleInput(input) {
    if (!gameActive || nextRoundPending) return; // 'í†µê³¼!' ìƒíƒœì¼ ë•Œ ì…ë ¥ ì°¨ë‹¨

    let currentTime = Date.now();
    if (!lastInputTime) {
        firstReactionTimes.push(currentTime - roundStartTime);
    } else {
        reactionTimes.push(currentTime - lastInputTime);
    }
    lastInputTime = currentTime;

    inputSequence += input;

    let patternElements = document.querySelectorAll(".pattern");
    if (inputSequence.length <= patternElements.length) {
        let targetElement = patternElements[inputSequence.length - 1];
        targetElement.classList.add("correct");
    }

    if (inputSequence === currentAnswer) {
        clearTimeout(timer);
        round++;

        // ì²« ë°˜ì‘ì†ë„ ë° í‰ê·  ë°˜ì‘ì†ë„ ê³„ì‚°
        let firstReaction = firstReactionTimes[firstReactionTimes.length - 1] || 0;
        let avgReaction = reactionTimes.length > 0 ? 
            Math.floor(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 0;

        document.getElementById("output").innerHTML = `í†µê³¼! Round: ${round}<br>
            ì²« ë°˜ì‘ì†ë„: ${firstReaction} ms<br>
            í‰ê· ì†ë„: ${avgReaction} ms`;

        nextRoundPending = true; // í†µê³¼ ë©”ì‹œì§€ í‘œì‹œ ì¤‘ ì…ë ¥ ì°¨ë‹¨

        setTimeout(() => {
            nextRoundPending = false; // ìƒˆë¡œìš´ ë¼ìš´ë“œ ì‹œì‘ ì „ ì…ë ¥ í—ˆìš©
            generateQuestion();
        }, 1000);
    } else if (!currentAnswer.startsWith(inputSequence)) {
        gameOver();
    }
}

        function startTimer() {
            let timerBar = document.getElementById("timer-bar");
            clearTimeout(timer);
            resetTimerBar();

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    timerBar.style.transition = "width 5s linear";
                    timerBar.style.width = "0%";
                });
            });

            timer = setTimeout(gameOver, 5000);
        }

        function resetTimerBar() {
            let timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
        }

        /**
 * ê²Œì„ ì¢…ë£Œ í›„ ë°˜ì‘ì†ë„ í‰ê·  ê³„ì‚° ë° ë¦¬í¬íŠ¸ í‘œì‹œ
 */
async function gameOver() {
    if (!gameActive) return;

    gameActive = false;
    clearTimeout(timer);

    backgroundMusic.pause();
    backgroundMusic.currentTime = 0;

    let gameOverSound = new Audio("game-over.mp3");
    gameOverSound.play().catch(error => console.log("ê²Œì„ ì˜¤ë²„ íš¨ê³¼ìŒ ì¬ìƒ ì˜¤ë¥˜:", error));

    document.getElementById("output").innerHTML = rankingCache;
    document.getElementById("start-buttons").style.display = "block";
    resetTimerBar();

    let avgFirstReaction = firstReactionTimes.length > 0 ? 
        Math.floor(firstReactionTimes.reduce((a, b) => a + b, 0) / firstReactionTimes.length) : 0;
    let avgReaction = reactionTimes.length > 0 ? 
        Math.floor(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 0;

    document.getElementById("output").innerHTML = `
        ê²Œì„ ë¦¬í¬íŠ¸<br><br>
        <strong>ë„ë‹¬ ë¼ìš´ë“œ:</strong> ${round}<br>
        <strong>ì²« ë°˜ì‘ì†ë„:</strong> ${avgFirstReaction} ms<br>
        <strong>í‰ê· ì†ë„:</strong> ${avgReaction} ms
    `;

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
        const userData = userSnap.data();
        const updatedPlayCount = (userData.play_count || 0) + 1;

        if (round > userData.round) {
            await setDoc(userRef, { ...userData, round, play_count: updatedPlayCount });
        } else {
            await setDoc(userRef, { ...userData, play_count: updatedPlayCount });
        }
    } else {
        await setDoc(userRef, { nickname, round, play_count: 1 });
    }
    
    await loadUserInfo();
    await loadPlayCount(); // í”Œë ˆì´ íšŸìˆ˜ ì—…ë°ì´íŠ¸
}
        window.startGame = startGame;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
        loadRanking();
        loadUserInfo();
        loadPlayCount();

    </script>
</body>
<footer style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 14px; color: black;">
    ë§Œë“ ì´ : ê°±ìƒì§ì¸<br>
    í›„ì› ê³„ì¢Œ : í† ìŠ¤ë±…í¬ 1908-6892-0626<br>
    ë¬¸ì˜ : insta @yejun0847
</footer>
</html>
 
